<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    
    <!-- <h1>index.html</h1>
    <button onclick="addItems()">addItems</button>
    -->
    
    <form action="">
        <textarea name="" id="txtarea" cols="30" rows="10"></textarea>
    </form>

    <button onclick="createDatabase()">createDatabase</button>
    <button onclick="deleteObjectStore()">deleteObjectStore</button>
    <button onclick="searchByKey()">searchByKey</button>
    <button onclick="searchByPrice()">searchByPrice</button>
    <button id="byKey">deleteByKey</button>
    <button id="byPrice">deleteByPrice</button>

    <script>
        // let x = indexedDB.deleteDatabase('db');
        
        let objectStoreCreated = false;
        let itemsAdded = false;

        function deleteObjectStore(params) {
            let request = indexedDB.open('db', 2);

            request.onupgradeneeded = function() {
                let db = this.result;

                db.deleteObjectStore('games');
                console.log('deleted')
            }
        }

        function createDatabase(params) {
            let request = indexedDB.open('db', 1);

            request.onupgradeneeded = function(e) {
                let db = this.result;
                if(!objectStoreCreated) {
                    let games = db.createObjectStore('games', {keyPath:'cds'});
                    let index = games.createIndex('price_idx', 'price')
                    objectStoreCreated = true;
                }
                console.log('successfully created');
            }

            request.onsuccess = function(e) {
                let db = this.result;
                
                db.onversionchange = function(e) {
                    this.close();
                    console.log('Database is outdated, please reload');
                };

                let transaction = db.transaction('games', 'readwrite');
                
                transaction.oncomplete = function (params) {
                    console.log('Transaction completed successfully')
                }
                
                let store = transaction.objectStore('games');
                
                function deleteByKey(params) {
                    let req = store.delete('asphalt')
                    req.onsuccess = function(e) {
                        console.log('deleted successfully')
                    };

                    req.onerror = function(e) {
                        console.log('error in deleting')
                    };

                }

                function deleteByPrice(params) {
                    let priceIndex = store.index('price_idx');
                    let req = priceIndex.getKey(121);

                    req.onsuccess = function(e) {
                        let key = this.result;
                        let deleteReq = store.delete(key)
                        console.log('deleted successfully')
                    }
                }

                byKey.onclick = deleteByKey;
                byPrice.onclick = deleteByPrice;
                
                function onSuccess(e) {
                    console.log('game added to store: ' + this.result);
                }

                function onError(e) {
                    console.log('error ' + e.error)
                }

                function addItems(items) {
                    for(let item in items) {
                        console.log(typeof item);
                        let request = store.add(items[item]);
                        
                        request.onsuccess = onSuccess;
                        request.onerror = onError;
                    }
                }

                if(!itemsAdded) {
                    let items = {
                        first : {
                            cds: 'callofduty',
                            price: 123,
                            created: new Date()
                        },
                        second : {
                            cds: 'asphalt',
                            price: 122,
                            created: new Date()
                        },
                        third : {
                            cds: 'whycity',
                            price: 121,
                            created: new Date()
                        },
                        fourth: {
                            cds: 'motogp',
                            price: 121,
                            created: new Date()
                        }
                    }
                    
                    addItems(items);
                    itemsAdded = true;

                } else {

                }
                
                transaction.onabort = function name(e) {
                    console.log('transaction aborted');
                };
            };

            request.onerror = function(e) {
                if(this.error.name == 'ConstraintError') {
                    console.log(error);
                    e.preventDefault();
                }
            };

            request.onblocked = function(e) {
                console.log('you did\'t closed the old connection, please close the older one then reload the page')
            };
        }

        function printValues(parameter) {
            let request1 = indexedDB.open('db', 1);

            request1.onsuccess = function(e) {
                let db = this.result;
                let transaction = db.transaction('games', 'readonly');
                let games = transaction.objectStore('games');
                let priceIndex = games.index('price_idx');

                let request2;
                if(parameter == 'byKey') request2 = games.getAll();
                if(parameter == 'byPrice') request2 = priceIndex.getAll(121);

                request2.onsuccess = function(e) {
                    if(request2.result !== 'undefined') {
                        console.log(this.result);
                    } else {
                        console.log('soory no games found')
                    }
                };

                request2.onerror = function (e) {
                    console.log('error in retreiving the data')
                }
            }
        }

        function searchByKey() {
            printValues('byKey')
        }

        function searchByPrice(params) {
            printValues('byPrice')
        }

</script>
</body>
</html>