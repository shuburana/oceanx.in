<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    
    <button onclick="createDatabase()">createDatabase</button>
    <button onclick="deleteStore()">deleteObjectStore</button>
    <button onclick="searchByKey()">searchByKey</button>
    <button onclick="searchByPrice()">searchByPrice</button>
    <button onclick="deleteDatabase()">deleteDatabase</button>
    <button onclick="byKey('callofduty')">deleteByKey</button>
    <button onclick="byPrice(121)">deleteByPrice</button>
    <button onclick="getUsingCursor()">getUsingCursor</button>

    <script>
        
        let objectStoreCreated = false;
        let itemsAdded = false;
        let byKey;
        let byPrice;

        function createDatabase(params) {
            let request = indexedDB.open('db', 1);

            request.onupgradeneeded = function(e) {
                let db = this.result;
                if(!objectStoreCreated) {
                    let games = db.createObjectStore('games', {keyPath:'cds'});
                    let index = games.createIndex('price_idx', 'price')
                    objectStoreCreated = true;
                }
            }

            request.onsuccess = function(e) {
                
                let db = this.result;
                
                db.onversionchange = function(e) {
                    this.close();
                    console.log('Database is outdated, please reload');
                };

                function getStore(params) {
                    let transaction = db.transaction('games', 'readwrite');
                    
                    transaction.oncomplete = function (params) {
                        console.log('Transaction completed successfully')
                    }
                    
                    transaction.onabort = function name(e) {
                        console.log('transaction aborted');
                    };

                    return transaction.objectStore('games');
                }
                                                
                function onSuccess(e) {
                    console.log('game added to store: ' + this.result);
                }

                function onError(e) {
                    // console.log('error ' + e.error)
                    for(let key in e) {
                        console.log(key, e[key]);
                    }
                }

                function addItems(items) {
                    for(let item in items) {
                        let request = getStore().add(items[item]);
                        
                        request.onsuccess = onSuccess;
                        request.onerror = onError;
                    }
                }

                if(!itemsAdded) {
                    let items = {
                        first : {
                            cds: 'a',
                            price: 1,
                            created: new Date()
                        },
                        second : {
                            cds: 'b',
                            price: 1,
                            created: new Date()
                        },
                        third : {
                            cds: 'c',
                            price: 2,
                            created: new Date()
                        },
                        fourth: {
                            cds: 'd',
                            price: 3,
                            created: new Date()
                        }
                    }
                    
                    addItems(items);
                    itemsAdded = true;

                } else {

                }
                            
                function deleteByKey(key) {
                    let deleteReq = getStore().delete(key);

                    deleteReq.onsuccess = function(e) {
                        console.log('deleted successfully')
                    };

                    deleteReq.onerror = function(e) {
                        console.log('error in deleting')
                    };
                }

                function deleteByPrice(price) { 
                    let priceIndex = getStore().index('price_idx');
                    let req = priceIndex.getKey(price);

                    req.onsuccess = function(e) {
                        let key = this.result;
                        let deleteReq = getStore().delete(key)
                        
                        deleteReq.onsuccess = function(e) {
                            console.log('deleted successfully')
                        }

                        deleteReq.onerror = function(e) {
                            console.log('error in deleting')
                        }
                    }
                }

                byKey = function(key) {
                    deleteByKey(key);
                }

                byPrice = function(price) {
                    deleteByPrice(price);
                }
            
            };

            request.onerror = function(e) {
                if(this.error.name == 'ConstraintError') {
                    console.log(error);
                    e.preventDefault();
                }
            };

            request.onblocked = function(e) {
                console.log('you did\'t closed the old connection, please close the older one then reload the page')
            };

        }

        function deleteDatabase(params) {
            indexedDB.deleteDatabase('db');
            console.log('database deleted successfully');
        }

        function printValues(parameter) {
            let request1 = indexedDB.open('db', 2);
            console.log(request1, 'executed');

            request1.onsuccess = function(e) {
                let db = this.result;
                
                db.onversionchange = function(e) {
                    this.close('old version closed');
                };

                let transaction = db.transaction('games', 'readonly');
                let games = transaction.objectStore('games');
                let priceIndex = games.index('price_idx');

                let request2;
                if(parameter == 'byKey') request2 = games.getAll();
                if(parameter == 'byPrice') request2 = priceIndex.getAll(121);

                request2.onsuccess = function(e) {
                    if(request2.result !== 'undefined') {
                        console.log(this.result);
                    } else {
                        console.log('soory no games found')
                    }
                };

                request2.onerror = function (e) {
                    console.log('error in retreiving the data')
                }
            }
        }

        function deleteStore(params) {
            let request = indexedDB.open('db', 2);
            
            request.onupgradeneeded = function(e) {
                let db = this.result;
                let deleteReq = db.deleteObjectStore('games');
                
                console.log('object store deleted successfully')
            }
        }

        function searchByKey() {
            printValues('byKey')
        }

        function searchByPrice(params) {
            printValues('byPrice')
        }
        
        function getUsingCursor(params) {
            let request = indexedDB.open('db', 2);

            request.onsuccess = function(e) {
                let db = this.result;

                let transaction = db.transaction('games');
                let store = transaction.objectStore('games');
                let index = store.index('price_idx');

                let request = index.openCursor(IDBKeyRange.lowerBound(1), 'prevunique');
                
                let counter = 0;
                let isCursorAdvanced = false;

                request.onsuccess = function(e) {
                    let cursor = this.result;
                    if(cursor) {
                        let primaryKey = cursor.primaryKey;
                        let key = cursor.key;
                        let value = cursor.value;

                        console.log(primaryKey, key, value);
                        cursor.continue();

                        // if(isCursorAdvanced) {
                        //     console.log(primaryKey, key, value);
                        //     cursor.continue();
                        // } else {
                        //     cursor.advance(1);
                        //     isCursorAdvanced = true;
                        // }
                    } else {
                        console.log('no more books in the store');
                    }
                }

            }
        }















































































































































































</script>
</body>
</html>